# 规格: 库存管理性能和用户体验修复

## MODIFIED Requirements

### Requirement: 库存查询性能优化

**描述:** 修复库存管理页面中的 N+1 查询问题，将多次数据库查询优化为单次聚合查询

**需求层级:** Critical

#### Scenario: 管理员查看库存列表时页面加载缓慢
**当** 管理员访问库存管理页面时
**且** 系统中有 50+ 个商品
**那么** 系统 **必须** 在 2 秒内完全加载完成
**且** 系统 **必须** 正确显示每个商品的库存状态

**验收标准:**
- 页面加载时间 < 2 秒
- 数据库查询次数从 N+1 减少到 1-2 次
- 所有库存统计数据准确无误
- 支持分页、搜索、筛选功能

### Requirement: 统一错误响应格式

**描述:** 统一所有库存管理 API 的响应格式，确保前端能正确处理成功和错误情况

**需求层级:** High

#### Scenario: 管理员添加库存时遇到错误
**当** 管理员提交添加库存请求时
**且** 服务器返回错误响应
**那么** 前端 **必须** 显示用户友好的错误信息
**且** 错误信息 **必须** 包含具体的失败原因

**验收标准:**
- 所有 API 响应使用统一的 `{ success: boolean, data?: any, error?: string }` 格式
- 错误信息对用户友好，不暴露技术细节
- 前端能正确处理 4xx 和 5xx 错误
- 网络错误有明确的提示

### Requirement: 改进用户反馈机制

**描述:** 为库存添加操作提供明确的成功反馈和状态更新

**需求层级:** High

#### Scenario: 管理员成功添加库存后获得反馈
**当** 管理员成功添加库存项时
**那么** 系统 **必须** 立即显示成功提示
**且** 系统 **必须** 自动刷新库存列表显示最新数据
**且** 系统 **必须** 关闭添加库存模态框

**验收标准:**
- 成功添加后显示 "成功添加 X 项库存" 的提示
- 库存列表自动更新，显示新的库存数量
- 模态框在 1-2 秒后自动关闭
- 成功提示在 3 秒后自动消失

### Requirement: 增强调试和监控能力

**描述:** 添加详细的日志记录和错误追踪，便于快速定位和解决问题

**需求层级:** Medium

#### Scenario: 开发人员排查库存添加失败问题
**当** 库存添加操作失败时
**那么** 系统 **必须** 记录详细的错误日志
**且** 日志 **必须** 包含请求参数、错误堆栈和相关上下文
**且** 系统 **必须** 便于开发人员快速定位问题根源

**验收标准:**
- 所有库存操作都有结构化日志记录
- 错误日志包含用户信息、时间戳、请求参数
- 关键操作有性能监控（查询时间、响应时间）
- 支持按操作类型和时间范围查询日志

## 技术约束

### 性能约束
- 库存列表查询响应时间 < 200ms
- 单次批量导入支持最多 1000 项
- 页面完全加载时间 < 2 秒

### 兼容性约束
- 保持现有 API 接口不变
- 前端界面布局和功能保持一致
- 支持现有的浏览器版本

### 安全约束
- 错误信息不泄露敏感数据
- 日志记录遵守隐私保护要求
- 管理员权限验证不变

## 实现细节

### 后端优化重点
1. **批量库存统计查询**: 实现单次查询获取多个商品的库存统计
2. **统一响应格式**: 使用 `src/utils/response.ts` 中的工具函数
3. **结构化日志**: 添加操作日志、错误日志、性能日志

### 前端改进重点
1. **即时反馈**: 成功/失败提示自动显示和消失
2. **状态管理**: 确保数据更新的原子性
3. **错误处理**: 友好的错误信息展示

### 测试要求
1. **性能测试**: 验证查询优化效果
2. **功能测试**: 确保所有功能正常工作
3. **用户体验测试**: 验证反馈机制的可用性