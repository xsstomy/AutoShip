# Order Administration Specification

## ADDED Requirements

### Requirement: 管理员订单管理界面
系统 SHALL 为管理员提供订单管理界面，支持查看、筛选和管理所有订单。

#### Scenario: 管理员访问订单管理页面
- **GIVEN** 管理员已通过身份认证
- **WHEN** 管理员访问订单管理页面路径（如 `/admin/orders`）
- **THEN** 系统显示订单管理界面，包括：
  - 订单列表（表格形式）
  - 筛选器组件
  - 分页控件
  - 操作按钮（查看、重发、退款）

#### Scenario: 管理员查看订单列表
- **GIVEN** 管理员在订单管理页面
- **WHEN** 页面加载或点击刷新按钮
- **THEN** 系统显示所有订单的详细信息：
  - 订单 ID（可点击链接）
  - 创建时间
  - 用户邮箱
  - 商品名称
  - 支付金额和币种
  - 支付方式（支付宝/Creem）
  - 订单状态（待支付/已支付/已发货/已完成/已退款）
  - 操作按钮

### Requirement: 订单筛选功能
系统 SHALL 支持管理员按多个维度筛选订单。

#### Scenario: 按订单状态筛选
- **GIVEN** 管理员在订单管理页面
- **WHEN** 管理员从状态下拉菜单选择特定状态（如"已支付"）
- **THEN** 系统 SHALL：
  - 过滤显示仅匹配选中状态的订单
  - 更新订单列表
  - 保持筛选条件在界面上显示

#### Scenario: 按支付方式筛选
- **GIVEN** 管理员在订单管理页面
- **WHEN** 管理员从支付方式下拉菜单选择特定方式（如"支付宝"）
- **THEN** 系统 SHALL：
  - 过滤显示仅匹配选中支付方式的订单
  - 更新订单列表显示

#### Scenario: 按日期范围筛选
- **GIVEN** 管理员在订单管理页面
- **WHEN** 管理员设置开始日期和结束日期
- **THEN** 系统 SHALL：
  - 过滤显示指定日期范围内的订单
  - 日期范围包括订单创建时间

#### Scenario: 按关键词搜索
- **GIVEN** 管理员在订单管理页面
- **WHEN** 管理员在搜索框输入订单 ID 或邮箱关键词
- **THEN** 系统 SHALL：
  - 实时搜索匹配输入关键词的订单
  - 支持模糊匹配
  - 更新订单列表显示匹配结果

#### Scenario: 多条件组合筛选
- **GIVEN** 管理员在订单管理页面
- **WHEN** 管理员同时使用多个筛选条件
- **THEN** 系统 SHALL：
  - 应用所有筛选条件（AND 逻辑）
  - 显示同时满足所有条件的订单
  - 可清除所有筛选条件并重置列表

### Requirement: 订单详情查看
系统 SHALL 支持管理员查看订单的完整详情信息。

#### Scenario: 查看订单详情
- **GIVEN** 管理员在订单列表页面
- **WHEN** 管理员点击订单 ID 或"查看详情"按钮
- **THEN** 系统 SHALL：
  - 打开订单详情模态框或导航到详情页面
  - 显示完整的订单信息：
    - 基本信息（订单 ID、创建时间、状态、用户邮箱）
    - 商品信息（名称、价格、数量）
    - 支付信息（支付方式、金额、币种、支付时间）
    - 发货记录（邮件发送时间、下载链接状态）
    - 操作日志（创建、支付、发货、退款等时间点）

### Requirement: 邮件重发功能
系统 SHALL 支持管理员手动重新发送订单发货邮件。

#### Scenario: 重发邮件确认
- **GIVEN** 管理员在订单详情页面或订单列表中
- **WHEN** 管理员点击"重发邮件"按钮
- **THEN** 系统 SHALL：
  - 显示确认对话框，包含订单信息摘要
  - 提示："确定要重新发送订单发货邮件给 {用户邮箱} 吗？"
  - 提供"确认"和"取消"按钮

#### Scenario: 执行邮件重发
- **GIVEN** 管理员点击重发邮件确认对话框的确认按钮
- **WHEN** 系统处理重发请求
- **THEN** 系统 SHALL：
  - 调用邮件服务（Resend API）重新发送发货邮件
  - 包含订单详情和商品信息（文本内容或下载链接）
  - 记录重发操作到操作日志
  - 显示成功提示："邮件重发成功"
  - 更新订单详情页面的操作日志

#### Scenario: 邮件重发失败
- **GIVEN** 管理员执行邮件重发操作
- **WHEN** 邮件服务返回错误或网络异常
- **THEN** 系统 SHALL：
  - 显示错误提示："邮件发送失败，请稍后重试"
  - 记录失败原因到日志
  - 不更新订单状态
  - 允许管理员再次尝试

#### Scenario: 重发权限限制
- **GIVEN** 管理员查看订单列表
- **WHEN** 系统显示订单操作按钮
- **THEN** 系统 SHALL：
  - 对已发货订单显示"重发邮件"按钮
  - 对未发货订单隐藏"重发邮件"按钮
  - 对已退款订单隐藏"重发邮件"按钮

### Requirement: 订单退款功能
系统 SHALL 支持管理员手动执行订单退款操作。

#### Scenario: 执行退款确认
- **GIVEN** 管理员在订单详情页面或订单列表中
- **WHEN** 管理员点击"退款"按钮
- **THEN** 系统 SHALL：
  - 显示确认对话框，包含风险提示
  - 提示："确定要对此订单执行退款吗？此操作不可撤销。"
  - 显示订单信息摘要（订单 ID、金额、用户邮箱）
  - 提供"确认退款"和"取消"按钮

#### Scenario: 执行退款操作
- **GIVEN** 管理员点击确认退款按钮
- **WHEN** 系统处理退款请求
- **THEN** 系统 SHALL：
  1. 验证订单状态（仅已支付订单可退款）
  2. 调用支付网关退款接口（支付宝/Creem）
  3. 等待支付网关确认退款结果
  4. 更新订单状态为 'refunded'
  5. 记录退款操作到操作日志
  6. 显示成功提示："退款操作成功"
  7. 刷新订单列表或详情显示

#### Scenario: 退款失败处理
- **GIVEN** 管理员执行退款操作
- **WHEN** 支付网关返回错误或超时
- **THEN** 系统 SHALL：
  - 显示错误提示："退款失败，请检查支付网关状态或联系技术支持"
  - 记录失败原因到日志
  - 不更新订单状态
  - 保持订单为原始状态
  - 允许管理员稍后重试

#### Scenario: 退款权限限制
- **GIVEN** 管理员查看订单列表
- **WHEN** 系统显示订单操作按钮
- **THEN** 系统 SHALL：
  - 对已支付订单显示"退款"按钮
  - 对已退款订单隐藏"退款"按钮
  - 对待支付订单隐藏"退款"按钮
  - 对已发货订单显示"退款"按钮

### Requirement: 分页和性能优化
系统 SHALL 提供分页功能以高效处理大量订单数据。

#### Scenario: 分页导航
- **GIVEN** 订单列表超过一页
- **WHEN** 管理员在订单管理页面
- **THEN** 系统 SHALL：
  - 显示分页控件（页码、上一页、下一页）
  - 每页显示固定数量订单（如 20 条）
  - 显示总订单数和当前页信息
  - 支持跳转到指定页码

#### Scenario: 分页状态保持
- **GIVEN** 管理员在使用筛选功能后进行分页操作
- **WHEN** 管理员翻页或应用筛选条件
- **THEN** 系统 SHALL：
  - 保持当前的筛选条件
  - 在新页面应用相同筛选条件
  - 正确计算筛选后的总页数

### Requirement: 操作日志记录
系统 SHALL 记录所有管理员执行的订单操作。

#### Scenario: 记录管理员操作
- **GIVEN** 管理员执行重发邮件或退款操作
- **WHEN** 操作完成（成功或失败）
- **THEN** 系统 SHALL：
  - 记录操作类型（resend_email/refund）
  - 记录操作时间
  - 记录操作者（管理员标识）
  - 记录操作结果（成功/失败及原因）
  - 可在订单详情页面查看操作日志

#### Scenario: 查看操作历史
- **GIVEN** 管理员在订单详情页面
- **WHEN** 管理员查看订单操作日志区域
- **THEN** 系统 SHALL：
  - 按时间倒序显示所有操作记录
  - 每条记录包含：操作类型、操作时间、操作者、操作结果
  - 支持导出操作日志（如 CSV 或 JSON 格式）

### Requirement: 管理员权限验证
系统 SHALL 确保只有经过认证的管理员可以访问订单管理功能。

#### Scenario: 未认证用户访问
- **WHEN** 未登录用户尝试访问订单管理页面
- **THEN** 系统 SHALL：
  - 重定向到管理员登录页面
  - 或显示 403 禁止访问错误

#### Scenario: 权限验证中间件
- **GIVEN** API 请求访问订单管理端点
- **WHEN** 请求到达后端
- **THEN** 系统 SHALL：
  - 验证管理员认证状态
  - 验证管理员权限
  - 未通过验证时返回 401/403 错误
  - 通过验证时正常处理请求

## MODIFIED Requirements

### Requirement: 管理员导航菜单
系统 SHALL 修改管理员后台导航菜单，添加订单管理入口。

#### Scenario: 导航菜单显示
- **GIVEN** 管理员已登录后台管理系统
- **WHEN** 系统渲染导航菜单
- **THEN** 导航菜单 SHALL 包含：
  - 商品管理（已有）
  - 库存管理（已有）
  - 订单管理（新加）
  - 其他现有菜单项

#### Scenario: 订单管理菜单项
- **GIVEN** 管理员查看导航菜单
- **WHEN** 管理员点击"订单管理"菜单项
- **THEN** 系统 SHALL：
  - 高亮显示当前页面菜单项
  - 导航到订单管理页面（/admin/orders）
  - 加载订单管理界面
