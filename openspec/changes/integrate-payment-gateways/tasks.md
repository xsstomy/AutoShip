# 支付网关集成任务清单

## 1. 创建支付网关服务类
**产出**: `Backend/src/services/payment-gateway-service.ts`
- [ ] 1.1 定义支付网关接口（IPaymentGateway）
- [ ] 1.2 创建支付宝服务类（AlipayGateway）
  - [ ] 1.2.1 实现RSA2签名算法
  - [ ] 1.2.2 实现支付链接生成
  - [ ] 1.2.3 实现回调参数解析
  - [ ] 1.2.4 实现签名验证
- [ ] 1.3 创建Creem服务类（CreemGateway）
  - [ ] 1.3.1 实现API Key认证
  - [ ] 1.3.2 实现支付链接生成
  - [ ] 1.3.3 实现回调参数解析
  - [ ] 1.3.4 实现Webhook验证
- [ ] 1.4 创建网关管理器（PaymentGatewayManager）
  - [ ] 1.4.1 动态路由到不同网关
  - [ ] 1.4.2 网关配置验证
  - [ ] 1.4.3 错误处理和降级

## 2. 创建支付服务
**产出**: `Backend/src/services/payment-service.ts`
- [ ] 2.1 集成支付网关服务
- [ ] 2.2 实现支付订单创建方法
- [ ] 2.3 实现支付URL生成
- [ ] 2.4 实现支付状态查询
- [ ] 2.5 集成ConfigService获取支付配置
- [ ] 2.6 添加审计日志记录

## 3. 更新订单API端点
**产出**: `Backend/src/routes/checkout.ts`
- [ ] 3.1 修改订单创建API，生成真实支付链接
- [ ] 3.2 添加支付状态查询API
- [ ] 3.3 添加支付重试API
- [ ] 3.4 完善错误处理和响应格式

## 4. 创建支付Webhooks路由
**产出**: `Backend/src/routes/webhooks.ts`
- [ ] 4.1 创建支付宝Webhook端点
  - [ ] 4.1.1 解析回调参数
  - [ ] 4.1.2 验证RSA2签名
  - [ ] 4.1.3 验证订单金额和状态
  - [ ] 4.1.4 更新订单状态
  - [ ] 4.1.5 记录支付原始数据
- [ ] 4.2 创建Creem Webhook端点
  - [ ] 4.2.1 解析回调参数
  - [ ] 4.2.2 验证Webhook密钥
  - [ ] 4.2.3 验证订单金额和状态
  - [ ] 4.2.4 更新订单状态
  - [ ] 4.2.5 记录支付原始数据
- [ ] 4.3 实现重复支付检测（幂等性）

## 5. 扩展数据库模型
**产出**: `Backend/src/db/schema.ts`
- [ ] 5.1 扩展payments_raw表（如果需要）
- [ ] 5.2 添加支付配置表字段（如果需要）
- [ ] 5.3 创建支付相关索引
- [ ] 5.4 验证数据库迁移脚本

## 6. 创建支付页面（可选）
**产出**: `frontend/src/pages/PaymentPage.tsx`
- [ ] 6.1 创建支付页面组件
- [ ] 6.2 集成支付URL跳转
- [ ] 6.3 实现支付状态轮询
- [ ] 6.4 添加支付超时处理
- [ ] 6.5 添加移动端适配

## 7. 集成测试和验证
**产出**: 测试文件
- [ ] 7.1 支付宝服务单元测试
- [ ] 7.2 Creem服务单元测试
- [ ] 7.3 支付服务集成测试
- [ ] 7.4 Webhook处理测试
- [ ] 7.5 手动测试支付流程
- [ ] 7.6 验证沙箱环境

## 8. 配置和文档
**产出**: 配置和文档
- [ ] 8.1 配置支付宝环境变量示例
- [ ] 8.2 配置Creem环境变量示例
- [ ] 8.3 创建支付API文档
- [ ] 8.4 创建支付流程图
- [ ] 8.5 更新README支付配置部分

## 9. 部署和监控
**产出**: 部署相关
- [ ] 9.1 验证生产环境配置
- [ ] 9.2 配置支付监控指标
- [ ] 9.3 设置支付错误告警
- [ ] 9.4 创建支付问题排查指南

## 10. 安全验证
**产出**: 安全测试
- [ ] 10.1 签名验证绕过测试
- [ ] 10.2 重放攻击防护测试
- [ ] 10.3 金额篡改测试
- [ ] 10.4 Webhook伪造测试
- [ ] 10.5 配置泄露检查

## 执行顺序
1. **第1阶段**（基础）：任务1-2（核心服务）
2. **第2阶段**（API）：任务3-4（接口和Webhook）
3. **第3阶段**（完善）：任务5-7（数据库和前端）
4. **第4阶段**（验证）：任务8-10（测试和部署）

## 依赖说明
- 任务1-2：独立可并行开发
- 任务3：依赖任务1-2完成后开始
- 任务4：依赖任务3完成后开始
- 任务5：可与任务1并行，但建议在任务4前完成
- 任务6：可选，可独立开发
- 任务7-10：依赖前面所有任务完成后开始

## 验收标准
- [ ] 支付宝和Creem支付链接生成成功
- [ ] Webhook回调正确验证和响应
- [ ] 订单状态准确更新
- [ ] 安全测试全部通过
- [ ] 单元测试覆盖率>80%
- [ ] 集成测试通过
- [ ] 文档完整清晰
