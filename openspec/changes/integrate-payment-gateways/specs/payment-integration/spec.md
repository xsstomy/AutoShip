# payment-integration Specification

## Purpose
实现支付集成页面功能，支持支付宝和 Creem 两个支付网关，提供完整的支付流程包括支付跳转、状态查询和结果处理。

## ADDED Requirements

### Requirement: 支付页面展示
系统 SHALL 显示支付页面，包含订单信息、支付金额和支付方式选择。

#### Scenario: 用户访问支付页面
- **GIVEN** 用户从下单页面成功创建订单并跳转到支付页面（/payment?orderId=123）
- **WHEN** 支付页面加载完成
- **THEN** 系统显示：
  - 订单ID和订单摘要信息
  - 支付金额（显示货币符号）
  - 支付方式选择（支付宝、Creem）
  - "立即支付"按钮（默认选中支付宝）

#### Scenario: 订单信息加载失败
- **GIVEN** 用户访问支付页面但订单ID无效或订单不存在
- **WHEN** 页面尝试加载订单信息
- **THEN** 系统显示错误提示："订单信息加载失败，请重新下单"并提供返回商品页面的链接

### Requirement: 支付方式选择
系统 SHALL 允许用户在支付宝和 Creem 支付方式之间进行选择。

#### Scenario: 用户选择支付宝支付
- **GIVEN** 用户在支付页面看到支付方式选项
- **WHEN** 用户点击"支付宝"支付方式
- **THEN** 系统：
  - 高亮显示支付宝选项
  - 显示支付宝支付图标和说明
  - "立即支付"按钮显示"支付宝支付"

#### Scenario: 用户选择 Creem 支付
- **GIVEN** 用户在支付页面看到支付方式选项
- **WHEN** 用户点击"Creem"支付方式
- **THEN** 系统：
  - 高亮显示 Creem 选项
  - 显示 Creem 支付图标和说明
  - "立即支付"按钮显示"Creem 支付"

### Requirement: 支付初始化
系统 SHALL 根据用户选择的支付方式初始化支付流程，并跳转到对应的支付页面。

#### Scenario: 支付宝支付初始化成功
- **GIVEN** 用户已选择支付宝支付方式
- **WHEN** 用户点击"支付宝支付"按钮
- **THEN** 系统：
  1. 发送请求到 `/api/v1/payment/init/{orderId}`，参数 `{ gateway: 'alipay' }`
  2. 显示加载状态（按钮显示"正在跳转..."）
  3. 获取支付URL后，在新窗口中打开支付宝支付页面
  4. 开始支付状态轮询
  5. 显示支付引导信息："请在支付宝页面完成支付"

#### Scenario: Creem 支付初始化成功
- **GIVEN** 用户已选择 Creem 支付方式
- **WHEN** 用户点击"Creem 支付"按钮
- **THEN** 系统：
  1. 发送请求到 `/api/v1/payment/init/{orderId}`，参数 `{ gateway: 'creem' }`
  2. 显示加载状态（按钮显示"正在跳转..."）
  3. 获取支付URL后，在新窗口中打开 Creem 支付页面
  4. 开始支付状态轮询
  5. 显示支付引导信息："请在 Creem 页面完成支付"

#### Scenario: 支付初始化失败
- **GIVEN** 用户选择支付方式并点击支付按钮
- **WHEN** 支付初始化API请求失败
- **THEN** 系统：
  1. 隐藏加载状态
  2. 显示错误提示："支付初始化失败，请稍后重试"
  3. 按钮恢复为可点击状态
  4. 提供"重新支付"选项

### Requirement: 支付状态查询
系统 SHALL 定期查询支付状态，并根据状态更新页面显示。

#### Scenario: 支付状态轮询启动
- **GIVEN** 支付初始化成功并已跳转到支付页面
- **WHEN** 支付页面开始状态查询
- **THEN** 系统每3秒发送一次请求到 `/api/v1/payment/status/{orderId}` 查询支付状态

#### Scenario: 支付状态查询 - 等待支付
- **GIVEN** 系统正在轮询支付状态
- **WHEN** API返回状态为 `pending` 或 `processing`
- **THEN** 系统显示：
  - "等待支付中..."状态信息
  - 支付倒计时（如有）
  - 刷新支付页面的选项

#### Scenario: 支付状态查询 - 支付成功
- **GIVEN** 系统正在轮询支付状态
- **WHEN** API返回状态为 `paid`
- **THEN** 系统：
  1. 停止状态轮询
  2. 显示支付成功信息："支付成功！正在跳转到订单详情页..."
  3. 3秒后自动跳转到订单详情页（`/order/{orderId}`）
  4. 关闭支付窗口（如果有）

#### Scenario: 支付状态查询 - 支付失败
- **GIVEN** 系统正在轮询支付状态
- **WHEN** API返回状态为 `failed` 或 `cancelled`
- **THEN** 系统：
  1. 停止状态轮询
  2. 显示支付失败信息："支付失败，请重新尝试"
  3. 提供"重新支付"按钮
  4. 提供"返回商品页面"选项

### Requirement: 支付超时处理
系统 SHALL 处理支付超时情况，防止无限等待。

#### Scenario: 支付超时
- **GIVEN** 用户已跳转到支付页面但长时间未完成支付
- **WHEN** 支付时间超过15分钟
- **THEN** 系统：
  1. 停止状态轮询
  2. 显示超时提示："支付超时，订单已取消"
  3. 提供"重新下单"选项
  4. 提供返回商品页面的链接

#### Scenario: 状态查询超时
- **GIVEN** 系统正在轮询支付状态
- **WHEN** 连续5次状态查询无响应
- **THEN** 系统：
  1. 显示网络错误提示："网络连接不稳定，请手动刷新页面"
  2. 提供"手动刷新状态"按钮
  3. 保持状态轮询继续

### Requirement: 支付页面响应式设计
系统 SHALL 在不同设备上提供良好的支付体验。

#### Scenario: 移动端支付页面
- **GIVEN** 用户使用手机浏览器访问支付页面
- **WHEN** 支付页面加载完成
- **THEN** 支付页面在移动端正确显示：
  - 订单信息垂直排列，字体大小适中
  - 支付方式按钮占满屏幕宽度
  - 支付按钮大小适合触摸操作
  - 支付跳转在移动端正常工作

#### Scenario: 桌面端支付页面
- **GIVEN** 用户使用桌面浏览器访问支付页面
- **WHEN** 支付页面加载完成
- **THEN** 支付页面在桌面端合理布局：
  - 订单信息居中显示，布局美观
  - 支付方式选择器大小适中
  - 支付页面在新窗口中打开
  - 状态更新信息清晰可见

### Requirement: 支付安全与验证
系统 SHALL 确保支付过程的安全性和数据的完整性。

#### Scenario: 订单ID验证
- **GIVEN** 用户访问支付页面
- **WHEN** 页面参数中的orderId格式不正确
- **THEN** 系统显示错误提示："无效的订单ID"并返回商品页面

#### Scenario: 支付参数验证
- **GIVEN** 用户点击支付按钮
- **WHEN** 发送支付初始化请求时
- **THEN** 系统验证：
  - 订单ID的有效性
  - 支付网关参数的合法性
  - 订单状态是否为待支付状态

### Requirement: 错误恢复机制
系统 SHALL 提供完善的错误恢复机制，允许用户从各种错误状态中恢复。

#### Scenario: 支付页面刷新恢复
- **GIVEN** 用户在支付过程中刷新页面
- **WHEN** 页面重新加载
- **THEN** 系统：
  1. 从URL参数恢复订单ID
  2. 重新查询订单信息和支付状态
  3. 根据当前状态显示相应页面内容

#### Scenario: 网络连接恢复
- **GIVEN** 支付过程中网络连接中断
- **WHEN** 网络连接恢复
- **THEN** 系统：
  1. 自动恢复状态轮询
  2. 显示连接恢复提示
  3. 继续支付状态监控

#### Scenario: 支付窗口意外关闭
- **GIVEN** 用户在支付过程中意外关闭了支付窗口
- **WHEN** 系统检测到支付窗口关闭
- **THEN** 系统：
  1. 提示用户支付窗口已关闭
  2. 提供"重新打开支付页面"选项
  3. 继续监控支付状态更新