# dynamic-currency-gateway Specification

## Purpose
实现前端价格显示与支付网关的智能关联，根据后端返回的已启用支付网关动态显示对应货币，并在支付时自动选择或推荐匹配的支付网关，提升用户体验和支付成功率。

## ADDED Requirements

### Requirement: 支付网关信息API扩展
系统 SHALL 提供详细的支付网关信息API，包含每个网关的支持货币和推荐货币。

#### Scenario: 获取支付网关列表
- **GIVEN** 前端需要了解可用的支付网关
- **WHEN** 调用 `GET /api/v1/payments/gateways`
- **THEN** 系统必须返回：
  - 网关ID、名称、显示名称
  - 支持的货币列表
  - 推荐货币
  - 是否启用状态
  - 货币到网关的映射关系
  - 格式：`{ success: true, data: { gateways: [...], currencyGatewayMap: {...} } }`

#### Scenario: 支付宝网关信息
- **GIVEN** 系统已启用支付宝网关
- **WHEN** 获取网关列表时
- **THEN** 系统必须返回：
  - `id: "alipay"`
  - `name: "alipay"`
  - `displayName: "支付宝"`
  - `supportedCurrencies: ["CNY"]`
  - `recommendedCurrency: "CNY"`
  - `isEnabled: true`

#### Scenario: Creem网关信息
- **GIVEN** 系统已启用Creem网关
- **WHEN** 获取网关列表时
- **THEN** 系统必须返回：
  - `id: "creem"`
  - `name: "creem"`
  - `displayName: "Creem"`
  - `supportedCurrencies: ["USD"]`
  - `recommendedCurrency: "USD"`
  - `isEnabled: true`

#### Scenario: 双网关启用
- **GIVEN** 系统同时启用支付宝和Creem
- **WHEN** 获取网关列表时
- **THEN** 系统必须返回：
  - 两个网关的完整信息
  - 货币映射：`CNY: ["alipay"], USD: ["creem"]`
  - 优先推荐CNY（国内用户友好）

#### Scenario: 无网关启用
- **GIVEN** 系统未启用任何支付网关
- **WHEN** 获取网关列表时
- **THEN** 系统必须返回：
  - 空网关列表
  - 货币映射为空对象
  - 保持API响应格式一致性
  - 不返回错误（仅返回空数据）

### Requirement: 商品详情页货币自动推荐
系统 SHALL 在商品详情页根据可用的支付网关自动推荐并显示对应的货币。

#### Scenario: 单网关启用场景（仅支付宝）
- **GIVEN** 系统仅启用支付宝网关
- **WHEN** 用户访问商品详情页时
- **THEN** 系统必须：
  - 自动将货币设置为CNY
  - 隐藏货币切换按钮（无需切换）
  - 在价格下方显示提示：`当前仅支持支付宝支付（人民币）`
  - 点击"立即购买"时使用CNY和支付宝

#### Scenario: 单网关启用场景（仅Creem）
- **GIVEN** 系统仅启用Creem网关
- **WHEN** 用户访问商品详情页时
- **THEN** 系统必须：
  - 自动将货币设置为USD
  - 隐藏货币切换按钮（无需切换）
  - 在价格下方显示提示：`当前仅支持Creem支付（美元）`
  - 点击"立即购买"时使用USD和Creem

#### Scenario: 双网关启用场景
- **GIVEN** 系统同时启用支付宝和Creem
- **WHEN** 用户访问商品详情页时
- **THEN** 系统必须：
  - 默认推荐显示CNY（国内用户友好）
  - 显示货币切换按钮（CNY/USD）
  - 用户可自由切换货币
  - 切换货币时价格自动转换
  - 根据选择的货币推荐对应网关

#### Scenario: 获取网关列表失败
- **GIVEN** 调用支付网关API失败或超时
- **WHEN** 商品详情页加载时
- **THEN** 系统必须：
  - 使用保守默认策略（CNY）
  - 显示货币切换按钮（保持原有行为）
  - 显示非阻塞错误提示：`部分功能可能受限，请刷新重试`
  - 不影响商品浏览和购买流程

#### Scenario: 货币切换逻辑
- **GIVEN** 用户在双网关环境下切换货币
- **WHEN** 点击货币切换按钮时
- **THEN** 系统必须：
  - 平滑过渡显示新货币价格
  - 保持价格换算准确性（使用汇率）
  - 更新本地存储的货币偏好
  - 切换动画流畅（<300ms）
  - 不触发重新加载页面

### Requirement: 支付方式智能推荐
系统 SHALL 根据订单选择的货币智能推荐并筛选对应的支付网关。

#### Scenario: CNY订单的支付方式
- **GIVEN** 订单货币为CNY
- **WHEN** 用户进入结算页面时
- **THEN** 系统必须：
  - 自动选中支付宝（推荐标识）
  - 隐藏或禁用Creem选项
  - Creem选项显示禁用提示：`不支持人民币，请选择支付宝`
  - 不允许用户选择不匹配的网关

#### Scenario: USD订单的支付方式
- **GIVEN** 订单货币为USD
- **WHEN** 用户进入结算页面时
- **THEN** 系统必须：
  - 自动选中Creem（推荐标识）
  - 隐藏或禁用支付宝选项
  - 支付宝选项显示禁用提示：`不支持美元，请选择Creem`
  - 不允许用户选择不匹配的网关

#### Scenario: 支付方式显示优化
- **GIVEN** 根据货币筛选后的支付方式
- **WHEN** 渲染支付方式选择组件时
- **THEN** 系统必须：
  - 推荐选项有明显的视觉标识（推荐徽章）
  - 禁用选项有灰色视觉样式
  - 禁用选项有点击提示（tooltip）
  - 显示支持的支付特性（如：扫码支付、国际支付等）

#### Scenario: 多网关货币匹配
- **GIVEN** 未来扩展多网关支持
- **WHEN** 订单使用某种货币
- **THEN** 系统必须：
  - 自动选择该货币的首选网关
  - 如果有多个匹配网关，显示所有可用选项
  - 按推荐度排序（首选在前）
  - 支持手动切换（在多匹配场景）

### Requirement: 货币-网关映射关系
系统 SHALL 建立明确的货币与支付网关的映射关系，确保支付流程的一致性。

#### Scenario: 建立映射关系
- **GIVEN** 系统配置的支付网关
- **WHEN** 初始化网关管理器时
- **THEN** 系统必须建立映射：
  - CNY ↔ alipay（人民币-支付宝）
  - USD ↔ creem（美元-Creem）
  - 支持一个货币映射多个网关
  - 支持一个网关支持多个货币（可扩展）

#### Scenario: 验证映射有效性
- **GIVEN** 货币-网关映射关系
- **WHEN** 创建支付订单时
- **THEN** 系统必须：
  - 验证订单货币与网关匹配
  - 不匹配时返回错误：`订单货币与支付网关不匹配`
  - 自动推荐匹配的网关
  - 记录映射关系用于审计

#### Scenario: 扩展新网关
- **GIVEN** 需要添加新的支付网关
- **WHEN** 配置新网关时
- **THEN** 系统必须：
  - 在映射关系中注册新网关
  - 指定支持货币和推荐货币
  - 更新API响应中的网关列表
  - 自动在支付方式中显示
  - 无需修改前端逻辑（配置驱动）

### Requirement: 错误处理和降级策略
系统 SHALL 在各种异常情况下提供合理的降级策略，确保核心功能可用。

#### Scenario: 网关API不可用
- **GIVEN** 支付网关API调用失败（网络错误、超时、500错误）
- **WHEN** 前端尝试获取网关列表时
- **THEN** 系统必须：
  - 捕获异常，不中断页面加载
  - 使用默认行为（CNY + 显示切换按钮）
  - 显示友好的错误提示（不阻塞用户操作）
  - 记录错误日志供排查
  - 提示用户刷新重试

#### Scenario: 网关配置不一致
- **GIVEN** 后端网关配置缺失或格式错误
- **WHEN** 初始化支付服务时
- **THEN** 系统必须：
  - 跳过无效网关，继续初始化其他网关
  - 记录配置错误日志
  - 返回可用网关列表（过滤掉无效项）
  - 管理员收到配置错误告警

#### Scenario: 用户强行选择不匹配网关
- **GIVEN** 用户尝试选择与订单货币不匹配的网关
- **WHEN** 在支付方式选择时
- **THEN** 系统必须：
  - 前端禁用不匹配选项（不允许选择）
  - 如果通过API直接创建不匹配订单，后端拒绝
  - 错误信息：`选择的支付网关不支持该货币`
  - 提供自动修正建议

### Requirement: 性能优化
系统 SHALL 确保动态货币推荐功能不影响页面加载性能和用户体验。

#### Scenario: 并行加载优化
- **GIVEN** 商品详情页加载时
- **WHEN** 获取商品信息和网关列表时
- **THEN** 系统必须：
  - 并行发起请求（Promise.all）
  - 等待两个请求都完成后再渲染完整页面
  - 加载过程中显示骨架屏或loading状态
  - 总加载时间 < 3秒

#### Scenario: 缓存策略
- **GIVEN** 用户在页面内多次操作
- **WHEN** 货币切换或重新获取网关信息时
- **THEN** 系统必须：
  - 在内存中缓存网关列表（页面生命周期）
  - 货币切换不重复调用API
  - 缓存有效期：5分钟
  - 手动刷新可强制更新缓存

#### Scenario: 货币切换响应性能
- **GIVEN** 用户频繁点击货币切换按钮
- **WHEN** 切换货币时
- **THEN** 系统必须：
  - 使用防抖机制（间隔 < 300ms 忽略）
  - 价格计算响应时间 < 200ms
  - 动画过渡流畅（60fps）
  - 不触发页面重新渲染整个区域

### Requirement: 用户体验优化
系统 SHALL 提供直观、流畅的用户体验，减少用户困惑。

#### Scenario: 清晰的视觉反馈
- **GIVEN** 不同支付网关和货币状态
- **WHEN** 用户查看商品和支付信息时
- **THEN** 系统必须：
  - 当前选择的货币有明确的货币符号和标签
  - 推荐选项有明显的"推荐"标识
  - 禁用选项有灰色样式和禁用提示
  - 切换货币时有平滑的过渡动画

#### Scenario: 智能默认选择
- **GIVEN** 用户首次访问商品详情页
- **WHEN** 页面加载完成时
- **THEN** 系统必须：
  - 自动选择最合适的货币（优先CNY）
  - 自动选择推荐的支付网关
  - 无需用户手动选择即可直接购买
  - 降低用户操作成本

#### Scenario: 帮助提示
- **GIVEN** 用户对货币或网关选择有疑问
- **WHEN** 用户将鼠标悬停在相关元素上时
- **THEN** 系统必须：
  - 提供tooltip解释为什么推荐此选项
  - 说明不同货币对应的支付方式
  - 提示货币切换的影响（如汇率差异）
  - 提供查看支付方式的链接

### Requirement: 测试覆盖
系统 SHALL 提供完整的测试覆盖，确保功能稳定可靠。

#### Scenario: 单元测试覆盖
- **GIVEN** 核心业务逻辑函数
- **WHEN** 运行单元测试时
- **THEN** 系统必须满足：
  - `getAvailableGateways()` 函数：>90% 覆盖率
  - `getRecommendedCurrency()` 函数：>90% 覆盖率
  - 货币-网关映射逻辑：>90% 覆盖率
  - 所有分支和异常场景都有测试

#### Scenario: 集成测试覆盖
- **GIVEN** 完整的用户操作流程
- **WHEN** 运行集成测试时
- **THEN** 系统必须测试：
  - 单网关场景（支付宝、Creem各一次）
  - 双网关场景（完整流程）
  - 网关API异常场景
  - 货币切换和支付推荐流程

#### Scenario: 端到端测试
- **GIVEN** 真实用户购买流程
- **WHEN** 执行E2E测试时
- **THEN** 系统必须验证：
  - 商品详情页 → 货币推荐正确
  → 结算页面 → 网关推荐正确
  → 创建订单 → 网关匹配
  → 完成支付 → 支付成功
  - 每个步骤的响应时间 < 2秒

## MODIFIED Requirements

### Requirement: 商品详情页货币显示逻辑
系统 SHALL 修改现有的货币显示逻辑，从用户手动切换改为根据可用支付网关智能推荐货币。

**MODIFIED FROM**: 用户手动切换货币，无限制
**MODIFIED TO**: 根据可用支付网关智能推荐货币，支持手动切换

#### Changed Scenario: 商品详情页加载
- **GIVEN** 商品详情页组件
- **WHEN** 页面初始化时
- **THEN** 系统必须：
  - **BEFORE**: 从localStorage读取货币偏好或默认CNY
  - **AFTER**: 调用API获取可用网关，根据网关推荐货币
  - **BEFORE**: 始终显示货币切换按钮
  - **AFTER**: 根据网关数量决定是否显示切换按钮

#### Changed Scenario: 货币切换按钮显示
- **GIVEN** 单网关启用场景
- **WHEN** 渲染商品详情页时
- **THEN** 系统必须：
  - **BEFORE**: 显示切换按钮，用户可随意切换
  - **AFTER**: 隐藏切换按钮，因为只有一个选择
  - **BEFORE**: 无提示
  - **AFTER**: 显示说明文本（如：`当前仅支持支付宝支付（人民币）`）

### Requirement: 支付方式选择逻辑
系统 SHALL 修改现有的支付方式选择逻辑，从硬编码单一网关改为根据订单货币动态筛选多个网关。

**MODIFIED FROM**: 支付方式列表硬编码，仅支付宝
**MODIFIED TO**: 根据订单货币动态筛选支付方式，支持多网关

#### Changed Scenario: 支付方式渲染
- **GIVEN** 结算页面的支付方式选择
- **WHEN** 组件初始化时
- **THEN** 系统必须：
  - **BEFORE**: 硬编码显示支付宝选项
  - **AFTER**: 根据订单货币筛选可用网关
  - **BEFORE**: 仅显示一个选项
  - **AFTER**: 可能显示1-2个选项（根据网关数量）
  - **BEFORE**: 用户必须手动选择
  - **AFTER**: 自动选中推荐网关

#### Changed Scenario: 网关推荐
- **GIVEN** 订单货币与网关匹配
- **WHEN** 渲染支付方式时
- **THEN** 系统必须：
  - **BEFORE**: 无推荐逻辑
  - **AFTER**: 自动选中匹配网关
  - **BEFORE**: 无视觉标识
  - **AFTER**: 推荐选项有"推荐"徽章
  - **BEFORE**: 所有选项平等显示
  - **AFTER**: 推荐选项优先排序

## Cross-References

### Related Specifications
- **payment-gateway**: 支付网关集成规范（依赖：网关配置、API接口）
- **checkout-flow**: 订单创建流程规范（依赖：订单创建、支付初始化）
- **database-model**: 数据库模型规范（依赖：订单表、支付记录表）

### Related Capabilities
- **支付网关管理**: 使用PaymentGatewayManager获取可用网关
- **配置管理**: 使用ConfigService读取网关配置
- **货币处理**: 使用currency.ts工具进行货币转换和格式化
- **审计日志**: 使用auditService记录支付相关事件

### Dependencies
- **必须依赖**: 支付网关基础设施（已完成）
- **可选依赖**: 货币汇率服务（当前使用固定汇率）
- **未来依赖**: 实时汇率API（用于更准确的货币转换）

## Constraints

### Technical Constraints
- 前端使用React + TypeScript
- 后端使用Hono + Drizzle ORM
- 数据库为SQLite/D1
- 必须支持移动端响应式设计

### Security Constraints
- 支付网关配置必须加密存储
- API调用需要适当的错误处理
- 不能信任客户端返回的货币选择（后端验证）

### Performance Constraints
- 页面加载时间 < 3秒
- 网关API响应时间 < 500ms
- 货币切换响应时间 < 200ms
- 内存使用增长 < 10MB

### Business Constraints
- 优先支持国内用户（默认CNY）
- 支付宝为主要支付方式
- Creem为国际支付补充
- 不支持实时汇率转换（当前版本）

## Validation

### Acceptance Criteria
- [ ] 商品详情页根据网关自动显示推荐货币
- [ ] 单网关时隐藏货币切换按钮
- [ ] 双网关时显示货币切换按钮
- [ ] 支付方式根据货币自动筛选和推荐
- [ ] 网关API调用失败时有适当降级
- [ ] 货币切换流畅，无页面闪烁
- [ ] 所有测试场景通过
- [ ] 性能指标满足约束

### Test Scenarios

#### Test Case 1: 仅支付宝启用
1. 后端配置：仅启用支付宝
2. 前端加载商品详情页
3. 验证：自动显示CNY，隐藏切换按钮
4. 进入结算页
5. 验证：仅显示支付宝，已选中
6. 创建订单
7. 验证：订单货币CNY，网关alipay

#### Test Case 2: 仅Creem启用
1. 后端配置：仅启用Creem
2. 前端加载商品详情页
3. 验证：自动显示USD，隐藏切换按钮
4. 进入结算页
5. 验证：仅显示Creem，已选中
6. 创建订单
7. 验证：订单货币USD，网关creem

#### Test Case 3: 双网关启用
1. 后端配置：启用支付宝和Creem
2. 前端加载商品详情页
3. 验证：默认CNY，显示切换按钮
4. 切换到USD
5. 验证：价格正确转换，货币符号更新
6. 进入结算页
7. 验证：仅显示Creem，已选中
8. 切换回CNY
9. 验证：仅显示支付宝，已选中

#### Test Case 4: 网关API异常
1. 模拟网关API调用失败
2. 前端加载商品详情页
3. 验证：使用默认CNY，显示切换按钮
4. 显示非阻塞错误提示
5. 功能基本可用（降级策略有效）

#### Test Case 5: 性能测试
1. 测试页面加载时间 < 3秒
2. 测试网关API响应 < 500ms
3. 测试货币切换响应 < 200ms
4. 验证内存使用正常

### Metrics

#### 功能性指标
- 网关识别准确率：100%
- 货币推荐准确率：100%
- 支付成功率提升：>10%（预期）
- 用户操作步数减少：平均减少1-2步

#### 性能指标
- 页面首屏渲染时间：< 2秒
- 网关列表获取时间：< 500ms
- 货币切换动画帧率：> 50fps
- API错误率：< 1%

#### 用户体验指标
- 用户困惑度降低：主观评估
- 支付方式选择时间：< 5秒
- 错误提示覆盖率：100%（所有异常场景）
