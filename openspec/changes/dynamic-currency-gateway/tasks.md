# 动态货币与支付网关关联 - 任务列表

## 📋 任务概述
实现前端价格显示与支付网关的智能关联，根据后端返回的可用支付网关自动推荐和显示对应货币，并在支付时选择正确的支付网关。

## 🎯 任务列表

### 1. 后端API扩展 (Backend)

#### ✅ 任务 1.1: 扩展 PaymentService.getAvailableGateways()
**文件**: `Backend/src/services/payment-service.ts`
**优先级**: 高
**预估时间**: 30分钟
**状态**: 待完成

**具体任务**:
- [ ] 修改 `getAvailableGateways()` 方法返回 `GatewayInfo[]` 格式
- [ ] 包含字段：`id`, `name`, `displayName`, `supportedCurrencies`, `recommendedCurrency`, `isEnabled`
- [ ] 建立货币-网关映射关系（alipay ↔ CNY, creem ↔ USD）
- [ ] 添加错误处理和日志记录
- [ ] 编写单元测试

**验收标准**:
```typescript
// 返回格式示例
[
  {
    id: "alipay",
    name: "alipay",
    displayName: "支付宝",
    supportedCurrencies: ["CNY"],
    recommendedCurrency: "CNY",
    isEnabled: true
  }
]
```

#### ✅ 任务 1.2: 扩展支付网关API响应
**文件**: `Backend/src/routes/checkout.ts` (GET /payments/gateways)
**优先级**: 高
**预估时间**: 20分钟
**状态**: 待完成

**具体任务**:
- [ ] 修改API响应格式，添加 `currencyGatewayMap` 字段
- [ ] 包含货币到网关ID的映射关系
- [ ] 保持向后兼容（现有字段不变）
- [ ] 添加响应数据验证
- [ ] 更新API文档

**验收标准**:
```json
{
  "success": true,
  "data": {
    "gateways": [...],
    "currencyGatewayMap": {
      "CNY": ["alipay"],
      "USD": ["creem"]
    }
  }
}
```

#### ✅ 任务 1.3: 测试后端API
**优先级**: 中
**预估时间**: 30分钟
**状态**: 待完成

**具体任务**:
- [ ] 测试单网关启用场景（仅支付宝）
- [ ] 测试单网关启用场景（仅Creem）
- [ ] 测试双网关启用场景
- [ ] 测试网关全部禁用场景
- [ ] 验证API响应格式正确性
- [ ] 编写集成测试

### 2. 前端API工具类 (Frontend)

#### ✅ 任务 2.1: 扩展 payment-api.ts
**文件**: `frontend/src/utils/payment-api.ts`
**优先级**: 高
**预估时间**: 40分钟
**状态**: 待完成

**具体任务**:
- [ ] 新增 `PaymentGatewayInfo` 接口定义
- [ ] 新增 `getAvailableGateways()` 函数
- [ ] 新增 `getRecommendedCurrency()` 辅助函数
- [ ] 新增 `getGatewaysByCurrency()` 辅助函数
- [ ] 添加TypeScript类型检查
- [ ] 添加错误处理和日志记录

**验收标准**:
```typescript
// 可以正确调用并解析后端API
const gateways = await getAvailableGateways();
// 返回: PaymentGatewayInfo[]

const recommendedCurrency = getRecommendedCurrency(gateways);
// 返回: 'CNY' | 'USD'
```

#### ✅ 任务 2.2: 编写API工具类测试
**优先级**: 中
**预估时间**: 20分钟
**状态**: 待完成

**具体任务**:
- [ ] 测试 `getAvailableGateways()` 正常场景
- [ ] 测试 `getAvailableGateways()` 错误场景
- [ ] 测试 `getRecommendedCurrency()` 单网关场景
- [ ] 测试 `getRecommendedCurrency()` 双网关场景
- [ ] 测试 `getRecommendedCurrency()` 空网关场景

### 3. 商品详情页优化 (Frontend)

#### ✅ 任务 3.1: 修改 ProductDetail.tsx
**文件**: `frontend/src/components/ProductDisplay/ProductDetail.tsx`
**优先级**: 高
**预估时间**: 60分钟
**状态**: 待完成

**具体任务**:
- [ ] 新增状态：`availableGateways`, `showCurrencyToggle`
- [ ] 在 `useEffect` 中调用 `getAvailableGateways()`
- [ ] 实现推荐货币选择逻辑
- [ ] 控制货币切换按钮显示/隐藏
- [ ] 添加错误处理和降级方案
- [ ] 添加加载状态指示
- [ ] 优化用户体验（防抖、提示等）

**验收标准**:
- [ ] 页面加载时自动获取网关列表
- [ ] 单网关时：自动设置对应货币，隐藏切换按钮
- [ ] 双网关时：推荐CNY，显示切换按钮
- [ ] 获取失败时：使用默认行为，显示提示
- [ ] 货币切换逻辑正确

#### ✅ 任务 3.2: 优化货币切换UI
**优先级**: 中
**预估时间**: 30分钟
**状态**: 待完成

**具体任务**:
- [ ] 当单网关时，显示提示文本：`当前仅支持支付宝支付（人民币）`
- [ ] 禁用货币切换按钮（视觉反馈）
- [ ] 添加 tooltip 解释为什么不能切换
- [ ] 优化切换按钮样式和交互

#### ✅ 任务 3.3: 测试商品详情页
**优先级**: 中
**预估时间**: 40分钟
**状态**: 待完成

**具体任务**:
- [ ] 测试仅支付宝启用场景
- [ ] 测试仅Creem启用场景
- [ ] 测试双网关启用场景
- [ ] 测试网关API调用失败场景
- [ ] 验证货币切换逻辑
- [ ] 验证价格显示正确性
- [ ] 测试无障碍访问（ARIA标签等）

### 4. 支付方式选择优化 (Frontend)

#### ✅ 任务 4.1: 修改 PaymentMethods.tsx
**文件**: `frontend/src/components/Payment/PaymentMethods.tsx`
**优先级**: 高
**预估时间**: 50分钟
**状态**: 待完成

**具体任务**:
- [ ] 新增属性：`orderCurrency?: Currency`
- [ ] 新增支付方式：Creem（完整配置）
- [ ] 实现根据订单货币筛选网关的逻辑
- [ ] 自动选中推荐网关（根据货币匹配）
- [ ] 禁用与订单货币不匹配的网关选项
- [ ] 添加禁用状态的视觉反馈
- [ ] 更新支付方式特性说明

**验收标准**:
- [ ] 订单货币为CNY时：仅显示/启用支付宝
- [ ] 订单货币为USD时：仅显示/启用Creem
- [ ] 推荐网关有明显的视觉标识
- [ ] 禁用网关有明确的禁用提示
- [ ] 支持手动切换（在多网关场景下）

#### ✅ 任务 4.2: 更新CheckoutPage.tsx
**文件**: `frontend/src/components/Checkout/CheckoutPage.tsx`
**优先级**: 中
**预估时间**: 30分钟
**状态**: 待完成

**具体任务**:
- [ ] 在创建订单时，自动设置网关为推荐网关
- [ ] 根据货币选择默认支付方式
- [ ] 添加网关选择的说明文本
- [ ] 优化表单验证逻辑

#### ✅ 任务 4.3: 测试支付方式选择
**优先级**: 中
**预估时间**: 30分钟
**状态**: 待完成

**具体任务**:
- [ ] 测试CNY订单的支付方式推荐
- [ ] 测试USD订单的支付方式推荐
- [ ] 测试手动切换支付方式
- [ ] 验证订单创建时网关选择
- [ ] 测试禁用状态的交互

### 5. 集成测试

#### ✅ 任务 5.1: 端到端测试
**优先级**: 高
**预估时间**: 60分钟
**状态**: 待完成

**具体任务**:
- [ ] 测试场景1：仅支付宝启用
  - 商品详情页显示CNY
  - 货币切换按钮隐藏
  - 支付方式仅显示支付宝
  - 订单创建和支付流程正常

- [ ] 测试场景2：仅Creem启用
  - 商品详情页显示USD
  - 货币切换按钮隐藏
  - 支付方式仅显示Creem
  - 订单创建和支付流程正常

- [ ] 测试场景3：双网关启用
  - 商品详情页默认CNY，显示切换按钮
  - 可切换到USD
  - 支付方式根据货币动态筛选
  - 订单创建和支付流程正常

- [ ] 测试场景4：网关配置异常
  - API调用失败时的降级处理
  - 用户友好的错误提示
  - 关键功能不受影响

#### ✅ 任务 5.2: 性能测试
**优先级**: 低
**预估时间**: 30分钟
**状态**: 待完成

**具体任务**:
- [ ] 测量页面加载时间（增加网关API调用的影响）
- [ ] 测试货币切换的响应速度
- [ ] 检查是否存在内存泄漏
- [ ] 验证移动端性能

#### ✅ 任务 5.3: 兼容性测试
**优先级**: 中
**预估时间**: 30分钟
**状态**: 待完成

**具体任务**:
- [ ] 测试不同浏览器（Chrome, Firefox, Safari, Edge）
- [ ] 测试移动端浏览器
- [ ] 测试降级场景（旧版本API）
- [ ] 测试网络异常场景

### 6. 文档和注释

#### ✅ 任务 6.1: 更新API文档
**优先级**: 低
**预估时间**: 20分钟
**状态**: 待完成

**具体任务**:
- [ ] 更新 `GET /api/v1/payments/gateways` 文档
- [ ] 添加响应格式说明
- [ ] 添加错误码说明
- [ ] 添加示例请求/响应

#### ✅ 任务 6.2: 添加代码注释
**优先级**: 低
**预估时间**: 30分钟
**状态**: 待完成

**具体任务**:
- [ ] 为核心逻辑添加注释
- [ ] 解释货币-网关映射关系
- [ ] 解释推荐算法
- [ ] 添加TODO标记待优化点

#### ✅ 任务 6.3: 更新变更日志
**优先级**: 低
**预估时间**: 10分钟
**状态**: 待完成

**具体任务**:
- [ ] 记录本次变更内容
- [ ] 标注向后兼容性
- [ ] 提供升级指南

## 📊 时间估算

| 阶段 | 任务数量 | 预估时间 | 优先级 |
|------|----------|----------|--------|
| 后端API扩展 | 3 | 80分钟 | 高 |
| 前端API工具类 | 2 | 60分钟 | 高 |
| 商品详情页优化 | 3 | 130分钟 | 高 |
| 支付方式选择优化 | 3 | 110分钟 | 高 |
| 集成测试 | 3 | 120分钟 | 高 |
| 文档和注释 | 3 | 60分钟 | 低 |
| **总计** | **17** | **560分钟** | **≈ 9-10小时** |

## 🚀 实施顺序

### 第一阶段：核心功能（高优先级）
1. 任务 1.1: 扩展 PaymentService.getAvailableGateways()
2. 任务 2.1: 扩展 payment-api.ts
3. 任务 3.1: 修改 ProductDetail.tsx
4. 任务 5.1: 端到端测试（基本场景）

### 第二阶段：完善功能（高优先级）
5. 任务 1.2: 扩展支付网关API响应
6. 任务 4.1: 修改 PaymentMethods.tsx
7. 任务 3.2: 优化货币切换UI
8. 任务 5.1: 端到端测试（完整场景）

### 第三阶段：测试和优化（中优先级）
9. 任务 1.3: 测试后端API
10. 任务 2.2: 编写API工具类测试
11. 任务 3.3: 测试商品详情页
12. 任务 4.2: 更新CheckoutPage.tsx
13. 任务 4.3: 测试支付方式选择
14. 任务 5.2: 性能测试

### 第四阶段：文档（低优先级）
15. 任务 6.1: 更新API文档
16. 任务 6.2: 添加代码注释
17. 任务 6.3: 更新变更日志

## ✅ 验收检查清单

### 功能验收
- [ ] 商品详情页根据网关自动设置货币
- [ ] 货币切换按钮显示/隐藏逻辑正确
- [ ] 支付方式根据货币动态筛选
- [ ] 网关推荐逻辑正确
- [ ] 错误处理和降级方案有效

### 质量验收
- [ ] 代码通过ESLint检查
- [ ] TypeScript类型检查通过
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试全部通过
- [ ] 无控制台错误或警告

### 性能验收
- [ ] 页面加载时间 < 3秒
- [ ] 网关API响应时间 < 500ms
- [ ] 货币切换响应时间 < 200ms
- [ ] 内存使用正常，无泄漏

### 兼容性验收
- [ ] 支持主流浏览器
- [ ] 支持移动端
- [ ] 向后兼容旧版本API
- [ ] 网络异常时有适当降级

## 🔗 相关资源

### 参考文档
- [支付网关集成规范](../integrate-payment-gateways/specs/payment-gateway/spec.md)
- [结算流程规范](../../specs/checkout-flow/spec.md)
- [前端货币处理工具](../..//frontend/src/utils/currency.ts)

### 依赖任务
- 支付网关基础设施（已完成）
- 商品展示功能（已完成）
- 订单创建流程（已完成）

### 后续任务
- 支付页面优化
- 多语言支持
- 汇率实时更新
- 支付方式个性化推荐
