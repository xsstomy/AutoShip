# 提案：迁移数据库驱动从 better-sqlite3 到 libsql

## 变更概要

将项目中的数据库驱动从 `better-sqlite3` 迁移到 `libsql`，以获得更好的云原生支持和现代化特性。

## Why

**better-sqlite3 的局限性：**
- 仅支持本地文件系统存储，无法适配云原生和分布式架构
- 在容器化和微服务环境中存在局限性
- 无法实现数据库的多实例共享和负载均衡
- 缺乏云服务集成的现代化特性

**libsql 的优势：**
- 完全兼容 SQLite 语法和特性
- 支持本地文件系统模式（向后兼容）
- 支持远程服务器模式，实现真正的云原生数据库
- 支持 TLS 加密、认证和授权
- 支持数据库复制和高可用架构
- 提供更好的并发控制和现代化 API
- 是 Turso 官方支持的现代化数据库解决方案

## 背景与动机

### 当前问题
- `better-sqlite3` 是本地文件系统数据库，不适合云原生部署
- 缺乏分布式支持和多实例共享能力
- 无法支持远程数据库连接
- 在容器化和微服务架构中存在局限性

### 解决方案
- 使用 `libsql`（原名 Turso SQL）作为 SQLite 的云原生替代
- 支持本地文件系统模式和远程服务器模式
- 保持与 SQLite 的兼容性
- 提供更好的并发控制和现代化特性

## 变更范围

### 受影响的组件
1. **数据库连接层** (`src/db/index.ts`)
   - 替换数据库驱动导入
   - 更新数据库初始化逻辑
   - 修改数据库配置方式

2. **依赖管理** (`package.json`)
   - 移除 `better-sqlite3` 和 `@types/better-sqlite3`
   - 添加 `@libsql/client`

3. **数据库迁移工具**
   - 更新 drizzle-orm 迁移器配置
   - 确保现有数据库文件可以迁移

4. **配置管理**
   - 添加 `LIBSQL_URL` 环境变量支持
   - 支持本地文件系统模式：`file:./database.db`
   - 支持远程服务器模式：`libsql://<url>`

## 技术影响

### 向后兼容性
- ✅ SQL 语法完全兼容
- ✅ Drizzle ORM 查询兼容
- ✅ 现有表结构无需修改
- ⚠️ 需要数据库迁移脚本

### 性能影响
- 📊 **本地模式**：性能与 better-sqlite3 类似
- 📊 **远程模式**：可能有网络延迟，但提供分布式能力
- 📊 **并发控制**：libsql 提供更好的多实例支持

### 部署影响
- **当前**：仅支持本地文件系统
- **未来**：支持本地文件系统 + 远程服务器模式
- **云原生**：更好的容器化和 Kubernetes 支持

## 风险评估

### 高风险
1. **数据迁移复杂性**
   - 风险：数据迁移失败或数据丢失
   - 缓解：完整备份 + 增量迁移测试

2. **连接配置错误**
   - 风险：数据库连接失败
   - 缓解：提供清晰的配置文档和回滚方案

### 中风险
3. **性能下降（远程模式）**
   - 风险：网络延迟影响性能
   - 缓解：默认使用本地模式，提供性能监控

4. **依赖兼容性问题**
   - 风险：@libsql/client 与现有依赖冲突
   - 缓解：全面测试 + 版本锁定

## 成功标准

- [ ] 所有单元测试通过
- [ ] 集成测试通过
- [ ] 性能测试通过（与现有性能相当或更好）
- [ ] 数据完整性验证通过
- [ ] 回滚方案验证通过

## 实施策略

### 阶段1：准备阶段
1. 评估依赖兼容性
2. 准备迁移脚本
3. 创建测试环境
4. 制定回滚方案

### 阶段2：实施阶段
1. 更新 package.json 依赖
2. 重构数据库连接代码
3. 更新配置管理
4. 执行数据迁移

### 阶段3：验证阶段
1. 运行所有测试
2. 性能基准测试
3. 数据一致性检查
4. 生产环境部署

## 回滚计划

如果迁移失败，执行以下回滚步骤：

1. 恢复 package.json 中的依赖
2. 恢复 src/db/index.ts 原始代码
3. 重新部署应用
4. 验证数据完整性

**预估回滚时间**：5-10分钟

## 相关文档

- [libsql 官方文档](https://docs.libsql.com/)
- [Drizzle ORM libsql 适配](https://orm.drizzle.team/docs/quick-start)
- [迁移指南](./design.md)

---

**提案状态**：待审核
**创建时间**：2025-11-15
**负责人**：待分配
