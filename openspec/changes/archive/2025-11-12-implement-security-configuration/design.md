## Context

自动发货网站作为涉及支付和数字产品交付的关键系统，需要多层次的安全防护。当前系统已有基础的订单管理和支付集成，但缺少统一的安全架构和配置管理。该项目处理敏感的用户订单信息、支付数据和数字商品，任何安全漏洞都可能导致财务损失和信誉风险。

## Goals / Non-Goals

### Goals
- 实现统一的Webhook签名验证，防止支付欺诈
- 提供安全的下载链接管理，防止未授权访问
- 建立完善的API访问控制和权限管理
- 实现配置热更新，支持生产环境运维
- 建立安全审计体系，满足合规要求
- 防范常见的Web攻击（XSS、CSRF、SQL注入）

### Non-Goals
- 不实现用户账户系统（保持无状态设计）
- 不实现复杂的企业级权限管理
- 不依赖外部认证服务（如OAuth）
- 不实现实时安全监控系统

## Decisions

### 1. Webhook安全架构
**决策**: 采用多层次的Webhook验证机制
- **签名验证**: 支付宝RSA2 + Creem HMAC
- **幂等性检查**: 基于gateway_order_id的去重
- **金额验证**: 确保回调金额与订单金额一致
- **时序检查**: 防止重放攻击

**理由**: 支付网关的安全模型各不相同，需要针对性的验证策略。多层次的验证能最大程度降低支付风险。

**替代方案**:
- 仅依赖签名验证（不够安全）
- 使用状态机检查（增加复杂度）

### 2. 下载链接安全
**决策**: 采用JWT + 数据库双重验证机制
- **JWT令牌**: 包含过期时间和下载次数信息
- **数据库验证**: 实时跟踪下载状态和IP地址
- **签名密钥**: 定期轮换的安全密钥

**理由**: JWT提供无状态验证，数据库提供详细的审计日志，两者结合在性能和安全性之间达到平衡。

**替代方案**: 纯数据库验证（性能差），纯JWT验证（缺少详细日志）

### 3. 配置管理系统
**决策**: 分层配置架构
- **环境变量**: 敏感信息（API密钥、数据库密码）
- **数据库配置**: 可动态调整的业务参数
- **配置文件**: 静态系统参数

**理由**: 不同类型的配置需要不同的安全等级和更新频率。分层设计既能保证安全性，又能提供运维灵活性。

### 4. 加密策略
**决策**: 对称加密 + 密钥分离
- **AES-256-GCM**: 敏感数据加密
- **密钥存储**: 环境变量 + 密钥轮换机制
- **哈希算法**: Argon2id用于密码哈希

**理由**: AES-256-GCM提供高强度的加密和完整性验证，Argon2id是当前最安全的密码哈希算法之一。

## Risks / Trade-offs

### 安全风险
**风险**: 密钥泄露导致数据解密
**缓解**:
- 密钥分离和定期轮换
- 最小权限原则
- 密钥使用审计

**风险**: Webhook验证被绕过
**缓解**:
- 多层验证机制
- 异常监控和告警
- 定期安全测试

### 性能权衡
**选择**: 额外的安全检查会降低API响应时间
**缓解**:
- 优化数据库索引
- 缓存常用配置
- 异步处理非关键安全日志

### 运维复杂性
**选择**: 增加了配置管理的复杂性
**缓解**:
- 提供详细的配置文档
- 实现配置验证机制
- 建立变更流程

## Migration Plan

### 阶段1: 基础设施（1-2周）
1. 创建数据库表结构
2. 实现基础配置管理
3. 部署加密工具模块

### 阶段2: Webhook安全（1周）
1. 实现签名验证中间件
2. 集成到现有支付处理流程
3. 测试各种攻击场景

### 阶段3: 下载链接安全（1周）
1. 实现JWT生成和验证
2. 更新下载API
3. 迁移现有下载链接

### 阶段4: API安全增强（1周）
1. 实现认证中间件
2. 添加访问控制
3. 更新管理员API

### 阶段5: 监控与审计（1周）
1. 实现安全日志记录
2. 配置监控告警
3. 建立安全响应流程

### 回滚计划
- 保留原有Webhook处理的降级路径
- 数据库变更可回滚
- 配置变更可快速回滚

## Open Questions

1. **密钥轮换频率**: 生产环境中加密密钥和JWT密钥的轮换周期应该多久？
2. **日志保留策略**: 安全审计日志的保留时间应该多长，如何平衡存储成本和合规需求？
3. **限流策略**: API限流的阈值应该如何设置，是否需要分用户类型？
4. **监控粒度**: 安全监控应该达到什么粒度，是否需要实时异常检测？

## Security Considerations

### 加密算法选择
- **对称加密**: AES-256-GCM（性能和安全平衡）
- **哈希算法**: Argon2id（抗GPU暴力破解）
- **密钥交换**: ECDH（密钥协商）

### 随机数生成
- **加密安全**: Node.js crypto.randomBytes()
- **令牌生成**: 32字节随机字符串 + Base64编码
- **盐值生成**: 每个用户/系统独立的随机盐

### 存储安全
- **敏感数据**: 加密存储，密钥分离
- **日志脱敏**: 避免记录敏感信息
- **备份加密**: 数据库备份文件加密

### 网络安全
- **HTTPS强制**: 生产环境强制使用TLS 1.3
- **HSTS**: 启用HTTP严格传输安全
- **CSP**: 内容安全策略防止XSS

## Implementation Notes

### TypeScript类型安全
所有安全相关的函数都必须使用严格的TypeScript类型定义，使用Zod进行运行时验证。

### 错误处理
安全相关的错误应该返回通用的错误消息，避免泄露敏感信息。详细错误信息只记录在日志中。

### 测试策略
除了单元测试，还需要集成测试和安全渗透测试。定期进行安全审计和代码审查。